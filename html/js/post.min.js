TEAMWORK.countRecipients=function(){return $("#recipients").find("option:selected").length};TEAMWORK.reset=function(){$("#recipient").attr("disabled",false);$("#message").attr("disabled",false);$("#post").attr("disabled",true);$("#enc").attr("disabled",true);$("#message").val("");$("#recipient-search").hide();if(TEAMWORK.countRecipients()>0){$("#recipient-team").show();$("#recipient").hide();$("#add-recipient").show();$("#message").focus()}else{$("#recipient-team").hide();$("#add-recipient").hide();$("#recipient").show();$("#recipient").focus()}};TEAMWORK.showError=function(a){if(a.endsWith("Session is expired or invalid")){TEAMWORK.showConfirmModal("Sorry","Your session has expired","Please click 'New Session' to get back on the saddle","/session","New Session")}else{TEAMWORK.showModal("Sorry","There was an error",a)}};$(function(){if(!Modernizr.formvalidation){window.location="/browser"}$(".chosen-select").chosen({width:"100%"});TEAMWORK.reset();$("#recipient").keypress(function(c){if(13===c.which){var b=$(this),a=b.val();b.attr("disabled",true);$("#recipient-search").show();$.post("/searchPublicKeys",{email:a.toLowerCase(),personId:TEAMWORK.person,sessionId:TEAMWORK.session}).done(function(d){if(d.msg&&d.err){TEAMWORK.showError(d.msg+": "+d.err)}else{if(d.msg){TEAMWORK.showError(d.msg)}else{if(d.err){TEAMWORK.showError(d.err)}else{if(d.length>0){$("#recipient-team").show()}else{TEAMWORK.showConfirmModal("Sorry","We could not find any public keys for "+a,"But if you have a copy, you can click 'Upload Public Key' to add it yourself","/upload","Upload Public Key")}$.each(d,function(e,f){if(f.key){$("body").append($("<div class='PK' style='display:none;'>"+f.key+"</div>"));$("#recipients").append("<option value='"+a+"' selected='selected'>"+a+"</option>");$("#recipients").trigger("chosen:updated")}})}}}$("#recipient-search").hide();b.attr("disabled",false);b.val("")}).fail(function(d){if(d.msg&&d.err){TEAMWORK.showError(d.msg+": "+d.err)}else{if(d.msg){TEAMWORK.showError(d.msg)}else{if(d.err){TEAMWORK.showError(d.err)}else{TEAMWORK.showError("")}}}$("#recipient-search").hide();b.attr("disabled",false);b.val("")});return false}});$("a.toggle").click(function(c){c.preventDefault();var b=$(this),a="#"+b.attr("href").split("#")[1];$(a).toggle(300);$(a).focus();b.toggle()});$("#message").on("change keyup paste",function(){if($("#post").is(":disabled")){var a=$("#message").val();if(a.length>0){$("#post").attr("disabled",false);$("#enc").attr("disabled",false)}}});$("#enc").on("change",function(){if($(this).is(":checked")){$("#post").attr("disabled",true);var b=[],a=$("#message").val();if(a.length<1){TEAMWORK.showError("Please type a message. There is nothing to encrypt");TEAMWORK.reset();$(this).attr("checked",false)}else{$(".PK").each(function(d){var e=$(this).text(),c=openpgp.key.readArmored(e);b.push(c.keys[0])});options={data:a,publicKeys:b,armor:true};openpgp.encrypt(options).then(function(c){$("#message").val(c.data);$("#message").attr("disabled",true);$("#post").attr("disabled",false)},function(c){TEAMWORK.reset();TEAMWORK.showError(c)})}}else{TEAMWORK.reset()}});$("#post").click(function(){$("#message").attr("disabled",false);return true});$("#reset").click(function(){TEAMWORK.reset()})});
TEAMWORK.countRecipients=function(){return $("#recipients").find("option:selected").length};TEAMWORK.selectedRecipients=function(){var a=[];$("#recipients option:selected").each(function(){a.push($(this).val())});return a};TEAMWORK.keyOwner=function(b){var a=null;if(TEAMWORK.keys[b]){a=TEAMWORK.keys[b]}return a};TEAMWORK.confirmRecipient=function(b){var a=false;$("#recipients option").each(function(){var c=$(this);if(c.val()==b){c.prop("selected",true);$("#recipients").trigger("chosen:updated");a=true}});return a};TEAMWORK.clearSelectedRecipients=function(){$("#recipients option:selected").prop("selected",false);$("#recipients").trigger("chosen:updated")};TEAMWORK.addMoreRecipients=function(){$("#recipient-team").show();$("#recipient").hide();$("#add-recipient").show();$("#message").focus()};TEAMWORK.reset=function(){$("#recipient").attr("disabled",false);$("#message").attr("disabled",false);$("#post").attr("disabled",true);$("#enc").attr("disabled",true);$("#message").val("");$("#recipient-search").hide();if(TEAMWORK.countRecipients()>0){TEAMWORK.addMoreRecipients()}else{$("#recipient-team").hide();$("#add-recipient").hide();$("#recipient").show();$("#recipient").val("");$("#recipient").focus()}};TEAMWORK.showError=function(a){if(a.endsWith("Session is expired or invalid")){TEAMWORK.showConfirmModal("Sorry","Your session has expired","Please click 'New Session' to get back on the saddle","/session","New Session")}else{TEAMWORK.showModal("Whoops!","Sorry, but it seems we have a problem:",a)}};$(function(){if(!Modernizr.formvalidation){window.location="/browser"}$(".chosen-select").chosen({width:"100%"});TEAMWORK.reset();$("#recipient").keypress(function(c){if(13===c.which){var b=$(this),a=b.val();b.attr("disabled",true);$("#recipient-search").show();$.post("/searchPublicKeys",{email:a.toLowerCase(),personId:TEAMWORK.person,sessionId:TEAMWORK.session}).done(function(d){if(d.msg&&d.err){TEAMWORK.showError(d.msg+": "+d.err)}else{if(d.msg){TEAMWORK.showError(d.msg)}else{if(d.err){TEAMWORK.showError(d.err)}else{if(d.length>0){$("#recipient-team").show()}else{TEAMWORK.showConfirmModal("Sorry","We could not find any public keys for "+a,"But if you have a copy, you can click 'Upload Public Key' to add it yourself","/upload","Upload Public Key")}$.each(d,function(e,f){if(f.key){$("body").append($("<div class='PK' id='"+f.id+"' style='display:none;'>"+f.key+"</div>"));TEAMWORK.keys[f.id]=a;if(!TEAMWORK.confirmRecipient(a)){$("#recipients").append("<option value='"+a+"' selected='selected'>"+a+"</option>")}$("#recipients").trigger("chosen:updated")}})}}}$("#recipient-search").hide();b.attr("disabled",false);b.val("")}).fail(function(d){if(d.msg&&d.err){TEAMWORK.showError(d.msg+": "+d.err)}else{if(d.msg){TEAMWORK.showError(d.msg)}else{if(d.err){TEAMWORK.showError(d.err)}else{TEAMWORK.showError("")}}}$("#recipient-search").hide();b.attr("disabled",false);b.val("")});TEAMWORK.addMoreRecipients();return false}});$("a.toggle").click(function(c){c.preventDefault();var b=$(this),a="#"+b.attr("href").split("#")[1];$(a).toggle(300);$(a).focus();b.toggle()});$("#message").on("change keyup paste",function(){if($("#post").is(":disabled")){var a=$("#message").val();if(a.length>0){$("#post").attr("disabled",false);$("#enc").attr("disabled",false)}}});$("#enc").on("change",function(){if($(this).is(":checked")){$("#post").attr("disabled",true);var c=[],b=$("#message").val(),a=TEAMWORK.selectedRecipients();if(b.length<1){TEAMWORK.showModal("Not so fast!","Please type a message first","There is nothing to encrypt");TEAMWORK.reset();TEAMWORK.addMoreRecipients();$(this).attr("checked",false)}else{if(a.length<1){TEAMWORK.showModal("Hold on!","It's not TeamWork without others","Please select at least one recipient first");TEAMWORK.reset();TEAMWORK.addMoreRecipients();$(this).attr("checked",false)}else{$(".PK").each(function(e){var f=$(this).text(),h=$(this).attr("id"),d=openpgp.key.readArmored(f),g=TEAMWORK.keyOwner(h);if($.inArray(g,a)>-1||$.inArray(h,TEAMWORK.authorKeys)>-1){c.push(d.keys[0])}});options={data:b,publicKeys:c,armor:true};openpgp.encrypt(options).then(function(d){$("#message").val(d.data);$("#message").attr("disabled",true);$("#post").attr("disabled",false)},function(d){TEAMWORK.reset();TEAMWORK.showError(d)})}}}else{TEAMWORK.reset()}});$("#post").click(function(){if(TEAMWORK.countRecipients()>0){$("#message").attr("disabled",false);return true}else{TEAMWORK.showModal("Wait up!","It seems like you forgot something:","Please select at least one recipient first");return false}});$("#reset").click(function(){TEAMWORK.reset();TEAMWORK.clearSelectedRecipients()})});
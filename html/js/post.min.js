TEAMWORK.countRecipients=function(){return $("#recipients").find("option:selected").length};TEAMWORK.selectedRecipients=function(){var a=[];$("#recipients option:selected").each(function(){a.push($(this).val())});return a};TEAMWORK.keyOwner=function(b){var a=null;if(TEAMWORK.keys[b]){a=TEAMWORK.keys[b]}return a};TEAMWORK.confirmRecipient=function(b){var a=false;$("#recipients option").each(function(){var c=$(this);if(c.val()==b){c.prop("selected",true);$("#recipients").trigger("chosen:updated");a=true}});return a};TEAMWORK.clearSelectedRecipients=function(){$("#recipients option:selected").prop("selected",false);$("#recipients").trigger("chosen:updated")};TEAMWORK.addMoreRecipients=function(){$("#recipient-team").show();$("#find-recipient").hide();$("#add-recipient").show();$("#message").focus()};TEAMWORK.reset=function(){$("#recipient").attr("disabled",false);$("#message").attr("disabled",false);$("#post").attr("disabled",true);$("#enc").attr("disabled",true);$("#message").val("");$("#recipient-search").hide();if(TEAMWORK.countRecipients()>0){TEAMWORK.addMoreRecipients()}else{$("#recipient-team").hide();$("#add-recipient").hide();$("#find-recipient").show();$("#recipient").val("");$("#recipient").focus()}};TEAMWORK.showError=function(a){if(a.endsWith("Session is expired or invalid")){TEAMWORK.showConfirmModal("Sorry","Your session has expired","Please click 'New Session' to get back on the saddle","/session","New Session")}else{TEAMWORK.showModal("Whoops!","Sorry, but it seems we have a problem:",a)}};$(function(){if(!Modernizr.formvalidation){window.location="/browser"}$(".chosen-select").chosen({width:"100%"});TEAMWORK.reset();function a(b){$("#recipient-search").show();$.post("/searchPublicKeys",{email:b.toLowerCase(),personId:TEAMWORK.person,sessionId:TEAMWORK.session}).done(function(c){if(c.msg&&c.err){TEAMWORK.showError(c.msg+": "+c.err)}else{if(c.msg){TEAMWORK.showError(c.msg)}else{if(c.err){TEAMWORK.showError(c.err)}else{if(c.length>0){$("#recipient-team").show()}else{TEAMWORK.showConfirmModal("Sorry","We could not find any public keys for "+b,"But if you have a copy, you can click 'Add Public Key' to add it yourself","/upload","Add Public Key")}$.each(c,function(e,f){if(f.key){$("body").append($("<div class='PK' id='"+f.id+"' style='display:none;'>"+f.key+"</div>"));TEAMWORK.keys[f.id]=b;if(!TEAMWORK.confirmRecipient(b)){$("#recipients").append("<option value='"+b+"' selected='selected'>"+b+"</option>")}$("#recipients").trigger("chosen:updated")}})}}}$("#recipient-search").hide();$("#recipient").attr("disabled",false);$("#recipient").val("");TEAMWORK.reset()}).fail(function(c){if(c.msg&&c.err){TEAMWORK.showError(c.msg+": "+c.err)}else{if(c.msg){TEAMWORK.showError(c.msg)}else{if(c.err){TEAMWORK.showError(c.err)}else{TEAMWORK.showError("")}}}$("#recipient-search").hide();$("#recipient").attr("disabled",false);$("#recipient").val("");TEAMWORK.reset()});return false}$("#find").click(function(b){b.preventDefault();$("#recipient").attr("disabled",true);return a($("#recipient").val())});$("#recipient").keypress(function(d){if(13===d.which){var c=$(this),b=c.val();c.attr("disabled",true);return a(b)}});$("a.toggle").click(function(f){f.preventDefault();var e=$(this),c=e.attr("href"),d="#"+c.split("#")[1],b="#"+c.split("#")[2];$(d).toggle(300);$(b).focus();e.toggle()});$("#message").on("change keyup paste",function(){if($("#post").is(":disabled")){var b=$("#message").val();if(b.length>0){$("#post").attr("disabled",false);$("#enc").attr("disabled",false)}}});$("#enc").on("change",function(){if($(this).is(":checked")){$("#post").attr("disabled",true);var d=[],c=$("#message").val(),b=TEAMWORK.selectedRecipients();if(c.length<1){TEAMWORK.showModal("Not so fast!","Please type a message first","There is nothing to encrypt");TEAMWORK.reset();TEAMWORK.addMoreRecipients();$(this).attr("checked",false)}else{if(b.length<1){TEAMWORK.showModal("Hold on!","It's not TeamWork without others","Please select at least one recipient first");TEAMWORK.reset();TEAMWORK.addMoreRecipients();$(this).attr("checked",false)}else{$(".PK").each(function(f){var g=$(this).text(),j=$(this).attr("id"),e=openpgp.key.readArmored(g),h=TEAMWORK.keyOwner(j);if($.inArray(h,b)>-1||$.inArray(j,TEAMWORK.authorKeys)>-1){d.push(e.keys[0])}});options={data:c,publicKeys:d,armor:true};openpgp.encrypt(options).then(function(e){$("#message").val(e.data);$("#message").attr("disabled",true);$("#post").attr("disabled",false)},function(e){TEAMWORK.reset();TEAMWORK.showError(e)})}}}else{TEAMWORK.reset()}});$("#post").click(function(){if(TEAMWORK.countRecipients()>0){$("#message").attr("disabled",false);return true}else{TEAMWORK.showModal("Wait up!","It seems like you forgot something:","Please select at least one recipient first");return false}});$("#reset").click(function(){TEAMWORK.reset();TEAMWORK.clearSelectedRecipients()})});